<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title id="pageTitle">數學科命題表</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1, h2 { color: #333; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 30px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f0f0f0; }
    .multi { color: red; font-weight: bold; }
    form { margin-top: 20px; }
    small { color: #666; }
    button.clear { background-color: red; color: white; padding: 5px 10px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1 id="pageHeader">數學科命題表</h1>
  <div id="giftsContainer"></div>

  <h2>預訂</h2>
  <form id="reserveForm">
    姓名：<input type="text" id="userName" required>
    編號：<input type="text" id="giftId" required placeholder="例如 2-3">
    <button type="submit">預訂</button>
  </form>

  <h2>取消</h2>
  <form id="removeForm">
    姓名：<input type="text" id="removeName" required>
    編號：<input type="text" id="removeGiftId" required placeholder="例如 2-3">
    <button type="submit">取消</button>
  </form>

  <button class="clear" id="clearAll">清除所有預訂資料</button>

  <script>
    // 自動標題年份
    const now = new Date();
    const baseYear = 2025; // 2025年對應民國114年
    const offset = now.getFullYear() - baseYear;
    const displayYear = 114 + offset;
    document.getElementById('pageTitle').innerText = `${displayYear}數學科命題表`;
    document.getElementById('pageHeader').innerText = `${displayYear}數學科命題表`;

    async function fetchGifts() {
      const res = await fetch('/gifts');
      const gifts = await res.json();

      const levels = [1, 2, 3];
      const giftNames = [...new Set(gifts.filter(g => !['3-5','3-7'].includes(g.id)).map(g => g.name))];

      const container = document.getElementById('giftsContainer');
      container.innerHTML = '<h2>總覽</h2>';
      const table = document.createElement('table');

      const headerRow = document.createElement('tr');
      headerRow.innerHTML = `<th>年級 \\ 項目</th>` + giftNames.map(name => `<th>${name}</th>`).join('');
      table.appendChild(headerRow);

      levels.forEach(level => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${level} 年級</td>`;

        giftNames.forEach((name, index) => {
          const giftId = `${level}-${index + 1}`;
          if (giftId === '3-5' || giftId === '3-7') {
            row.innerHTML += '<td></td>';
            return;
          }

          const gift = gifts.find(g => g.id === giftId);
          const reserved = gift?.reservedBy || [];
          const cellContent = reserved.length > 1
            ? `<span class="multi">${reserved.join(', ')}</span>`
            : reserved.join(', ') || '';

          const td = document.createElement('td');
          td.innerHTML = `${cellContent}${cellContent ? '<br>' : ''}<small>(${gift.id})</small>`;
          row.appendChild(td);
        });

        table.appendChild(row);
      });

      container.appendChild(table);

      // 額外項目
      const extras = gifts.filter(g => g.level === 0); // 額外項目 level = 0
      if (extras.length) {
        const extraDiv = document.createElement('div');
        extraDiv.innerHTML = '<h2>額外項目</h2>';
        const ul = document.createElement('ul');
        extras.forEach(g => {
          const li = document.createElement('li');
          const reserved = g.reservedBy.length > 1
            ? `<span class="multi">${g.reservedBy.join(', ')}</span>`
            : g.reservedBy.join(', ');
          li.innerHTML = `${g.name}：${reserved || '尚未預訂'} <small>(${g.id})</small>`;
          ul.appendChild(li);
        });
        extraDiv.appendChild(ul);
        container.appendChild(extraDiv);
      }
    }

    document.getElementById('reserveForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const userName = document.getElementById('userName').value;
      const giftId = document.getElementById('giftId').value.trim();
      const res = await fetch('/reserve', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userName, giftId })
      });
      const result = await res.json();
      alert(result.message);
      fetchGifts();
    });

    document.getElementById('removeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const userName = document.getElementById('removeName').value;
      const giftId = document.getElementById('removeGiftId').value.trim();
      const res = await fetch('/remove', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userName, giftId })
      });
      const result = await res.json();
      alert(result.message);
      fetchGifts();
    });

    document.getElementById('clearAll').addEventListener('click', async () => {
      if (confirm('你確定要清除所有預訂紀錄嗎？')) {
        const res = await fetch('/clear', { method: 'POST' });
        const result = await res.json();
        alert(result.message);
        fetchGifts();
      }
    });

    fetchGifts();
  </script>
</body>
</html>
